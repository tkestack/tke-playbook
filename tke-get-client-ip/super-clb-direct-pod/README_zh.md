[English](README.md) | [ä¸­æ–‡](README_zh.md)

## é¡¹ç›®æ¦‚è¿°

æœ¬å¼€æºé¡¹ç›®æä¾›ä¸€é”®å¼è§£å†³æ–¹æ¡ˆï¼Œåœ¨è…¾è®¯äº‘å®¹å™¨æœåŠ¡ï¼ˆTKEï¼‰è¶…çº§èŠ‚ç‚¹æ¨¡å¼ä¸‹ï¼Œé€šè¿‡CLBç›´è¿Podæ¨¡å¼ï¼Œè·å–å®¢æˆ·ç«¯çœŸå®æºIPã€‚é€‚ç”¨äºå®¡è®¡ã€é£æ§ç­‰å¯¹æºIPæ•æ„Ÿçš„åœºæ™¯ã€‚æ ¸å¿ƒä¼˜åŠ¿ï¼š
- â€‹**ä¸€é”®éƒ¨ç½²**â€‹ï¼šæ•´åˆDeploymentå’ŒServiceåˆ›å»ºï¼Œé¿å…æ‰‹åŠ¨æ­¥éª¤ã€‚
- â€‹**ä¸€é”®éªŒè¯**â€‹ï¼šè‡ªåŠ¨è·å–CLB IPå¹¶æµ‹è¯•æºIPï¼Œç¡®ä¿ä¸šåŠ¡å®æ—¶ç”Ÿæ•ˆã€‚
- â€‹**å¼€ç®±å³ç”¨**â€‹ï¼šåŸºäºæ ‡å‡†Kuberneteså‘½ä»¤ï¼Œæ— éœ€å¤æ‚é…ç½®ã€‚

é€šè¿‡ä¸‰ä¸ªè„šæœ¬å®ç°å…¨æµç¨‹ç®¡ç†ï¼š
- `deploy.sh`ï¼šä¸€é”®éƒ¨ç½²åº”ç”¨å’ŒService
- `verify.sh`ï¼šä¸€é”®éªŒè¯å®¢æˆ·ç«¯æºIP
- `cleanup.sh`ï¼šä¸€é”®æ¸…ç†èµ„æº

## ğŸ“¡ ä¸šåŠ¡è®¿é—®é“¾è·¯æµç¨‹å›¾

```mermaid
graph LR
    
    A[å®¢æˆ·ç«¯] -->|HTTP/HTTPSè¯·æ±‚| B{æµé‡å…¥å£}
    B --> C[LBç±»å‹Service]
    B --> D[LBç±»å‹Ingress]
    
    C -->|ç›´è¿æ¨¡å¼| E[ä¸šåŠ¡Pod]
    D -->|ç›´è¿æ¨¡å¼| E
    
    subgraph TKEé›†ç¾¤
        E[è¶…çº§èŠ‚ç‚¹<br>VPC-CNIç½‘ç»œ<br>ä¸šåŠ¡Pod]
    end
    
     A <--> |å“åº”æ•°æ®| E
    
    style A fill:#4CAF50,color:white
    style B fill:#2196F3,color:white
    style C fill:#FF9800,color:black
    style D fill:#FF9800,color:black
    style E fill:#9C27B0,color:white
```

## ğŸ›  å‰ç½®æ¡ä»¶

åœ¨æ‰§è¡Œä¸€é”®æ“ä½œå‰ï¼Œç¡®ä¿æ‚¨çš„ç¯å¢ƒæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š
- â€‹**é›†ç¾¤ç¯å¢ƒ**â€‹ï¼šTKEé›†ç¾¤å·²å¯ç”¨è¶…çº§èŠ‚ç‚¹ï¼ˆæ§åˆ¶å°è·¯å¾„ï¼šèŠ‚ç‚¹ç®¡ç† â†’ èŠ‚ç‚¹æ±  â†’ å¯ç”¨è¶…çº§èŠ‚ç‚¹ï¼‰ã€‚
	- é›†ç¾¤ç½‘ç»œæ¨¡å¼ä¸ºVPC-CNIï¼ˆåˆ›å»ºé›†ç¾¤æ—¶éœ€é€‰æ‹©ï¼‰ã€‚
- â€‹**èµ„æºè¦æ±‚**â€‹ï¼šè…¾è®¯äº‘è´¦æˆ·ä½™é¢å……è¶³ï¼Œæ— å¸¦å®½é™åˆ¶ï¼ˆé¿å…è®¿é—®å¤±è´¥ï¼‰ã€‚
	- è·å–é›†ç¾¤è®¿é—®å‡­è¯è¯´æ˜ï¼šè¯·å‚è€ƒ[è¿æ¥é›†ç¾¤](https://cloud.tencent.com/document/product/457/39814)
- â€‹**é•œåƒè¯´æ˜**â€‹ï¼šé»˜è®¤ä½¿ç”¨æµ‹è¯•é•œåƒ `vickytan-demo.tencentcloudcr.com/kestrelli/images:v1.0`ï¼Œæ‚¨å¯åœ¨./deploy.shæ–‡ä»¶ä¸­è‡ªå®šä¹‰æ›¿æ¢ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹
##### æœ¬æ¬¡æ“ä½œä»¥LBç±»å‹svcä¸ºä¾‹ï¼ŒLBç±»å‹ingressåŒæ ·é€‚ç”¨äºæ­¤ä¸šåŠ¡åœºæ™¯

### æ­¥éª¤1ï¼šéƒ¨ç½²åº”ç”¨

```
# 1. ä¸‹è½½é¡¹ç›®
git clone https://github.com/kestrelli/client-ip.git
cd client-ip
cd super-clb-direct-pod
# 2. æˆæƒæ‰§è¡Œæƒé™
chmod +x *.sh
# 3. æ‰§è¡Œéƒ¨ç½²è„šæœ¬ï¼ˆéœ€è¦kubectlæƒé™ï¼‰
./deploy.sh
```
éƒ¨ç½²è¿‡ç¨‹çº¦1åˆ†é’Ÿï¼Œè‡ªåŠ¨å®Œæˆï¼š
- å¯ç”¨GlobalRouteç›´è¿æ¨¡å¼
- åˆ›å»ºä¸šåŠ¡è´Ÿè½½(Deployment)
- é…ç½®ç›´è¿Service
- è·å–CLBå…¬ç½‘IP

![å¤åˆ»ä»“åº“æ–‡ä»¶](images/pod1.png)
![éƒ¨ç½²](images/pod2.png)

### æ­¥éª¤2ï¼šéªŒè¯æºIP

```
# è¿è¡ŒéªŒè¯è„šæœ¬
./verify.sh

# é¢„æœŸè¾“å‡ºï¼š
éªŒè¯ç»“æœï¼š
{"remote_addr":"172.18.0.1"} 
å®¢æˆ·ç«¯çœŸå®IPæ˜¾ç¤ºåœ¨ remote_addr å­—æ®µ
```
![è¿è¡Œ](images/pod3.png)

### æ­¥éª¤3ï¼šæ¸…ç†èµ„æº

```
# æ‰§è¡Œæ¸…ç†è„šæœ¬ï¼ˆéœ€è¦kubectlæƒé™ï¼‰
./cleanup.sh
```
![æ¸…ç†](images/pod4.png)

## âœ… éªŒè¯æ ‡å‡†


|éªŒè¯é¡¹|æˆåŠŸæ ‡å‡†|æ£€æŸ¥å‘½ä»¤|
|:-:|:-:|:-:|
|â€‹**éƒ¨ç½²çŠ¶æ€**â€‹|DeploymentçŠ¶æ€Availableï¼ŒPodå…¨éƒ¨Running|`kubectl get deploy real-ip-app`<br>`kubectl get pods -l app=real-ip-app`|
|â€‹**ServiceçŠ¶æ€**â€‹|Serviceæœ‰å…¬ç½‘IP|`kubectl get svc clb-direct-pod`|
|â€‹**æºIPéªŒè¯**â€‹|è¿”å›çœŸå®å®¢æˆ·ç«¯IP|`./verify.sh`|

#### è‡ªå®šä¹‰ä¸šåŠ¡æµ‹è¯•é•œåƒ
```
# ä¿®æ”¹deploy.shä¸­çš„é•œåƒåœ°å€
sed -i 's|vickytan-demo.tencentcloudcr.com|your-registry.com|g' deploy.sh
```

### âš ï¸ æ•…éšœæ’æŸ¥


|ç°è±¡|è§£å†³æ–¹æ¡ˆ|
|:-:|:-:|
|PodçŠ¶æ€å¼‚å¸¸|`kubectl describe pod <pod-name>`<br>`kubectl logs <pod-name>`|
|Serviceæ— å…¬ç½‘IP|æ£€æŸ¥è´¦æˆ·ä½™é¢å’ŒCLBé…é¢|
|è·å–åˆ°èŠ‚ç‚¹IP|ç¡®è®¤Serviceæ³¨è§£ `direct-access: "true"`|
|è®¿é—®è¶…æ—¶|æ£€æŸ¥å®‰å…¨ç»„è§„åˆ™å’Œç½‘ç»œACL|

### ğŸ“¦ é¡¹ç›®ç»“æ„

```
super-clb-direct-pod/
â”œâ”€â”€ deploy.sh       # ä¸€é”®éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ verify.sh       # éªŒè¯è„šæœ¬
â”œâ”€â”€ cleanup.sh      # æ¸…ç†è„šæœ¬
â”œâ”€â”€ README.md       # æœ¬æ–‡æ¡£
```
